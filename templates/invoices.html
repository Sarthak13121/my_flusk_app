<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoices Management</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        /* Basic Styling for the Invoicing UI */
        .invoice-container { padding: 20px; }
        .invoice-list { margin-top: 20px; }
        .invoice-card { 
            border: 1px solid #ccc; 
            padding: 15px; 
            margin-bottom: 10px; 
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .invoice-header { font-weight: bold; }
        .actions button { margin-left: 10px; }

        /* Modal specific styles */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 700px; border-radius: 8px; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; }
        .close:hover, .close:focus { color: #000; text-decoration: none; cursor: pointer; }

        /* Line Item Table Styling */
        #lineItemsTable { width: 100%; margin-top: 15px; border-collapse: collapse; }
        #lineItemsTable th, #lineItemsTable td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    </style>
</head>
<body>
    <header>
        <nav>
            <a href="/">Dashboard</a>
            <a href="/clients">Clients</a>
            <a href="/tasks">Tasks</a>
            <a href="/invoices" class="active">Invoices</a>
        </nav>
        <span class="user-info">Welcome, {{ username }}</span>
        <a href="/logout">Logout</a>
    </header>

    <div class="invoice-container">
        <h1>Invoice Management</h1>
        <button id="openModalBtn">+ Create New Invoice</button>

        <div id="invoiceList" class="invoice-list">
            </div>
    </div>

    <div id="invoiceModal" class="modal">
        <div class="modal-content">
            <span class="close" id="closeModalBtn">&times;</span>
            <h2>Create New Invoice</h2>
            
            <label for="clientSelect">Select Client:</label>
            <select id="clientSelect"></select><br><br>

            <label for="invoiceNumber">Invoice Number:</label>
            <input type="text" id="invoiceNumber" placeholder="INV-001" required><br><br>

            <label for="issueDate">Issue Date:</label>
            <input type="date" id="issueDate" required><br><br>

            <label for="dueDate">Due Date:</label>
            <input type="date" id="dueDate"><br><br>

            <h3>Line Items</h3>
            <table id="lineItemsTable">
                <thead>
                    <tr>
                        <th>Description</th>
                        <th>Qty</th>
                        <th>Unit Price</th>
                        <th>Subtotal</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="lineItemsBody">
                    <tr class="line-item-row">
                        <td><input type="text" class="item-description" required></td>
                        <td><input type="number" class="item-quantity" min="1" value="1" oninput="calculateSubtotal(this.parentNode.parentNode)" required></td>
                        <td><input type="number" class="item-price" min="0.01" step="0.01" value="0.00" oninput="calculateSubtotal(this.parentNode.parentNode)" required></td>
                        <td><span class="item-subtotal">0.00</span></td>
                        <td><button onclick="removeLineItem(this.parentNode.parentNode)">Remove</button></td>
                    </tr>
                </tbody>
            </table>
            <p style="text-align: right;"><strong>Total Amount: </strong><span id="invoiceTotal">0.00</span></p>
            <button onclick="addLineItem()">+ Add Line Item</button><br><br>
            
            <button onclick="submitNewInvoice()">Create Invoice</button>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        let clients = []; // Store client data for the dropdown

        document.addEventListener('DOMContentLoaded', () => {
            fetchInvoicesAndClients();
            setupModalListeners();
        });

        // --- FETCHING DATA ---

        async function fetchInvoicesAndClients() {
            try {
                // Fetch Clients for the dropdown
                const clientResponse = await fetch(`${API_BASE}/clients`);
                clients = await clientResponse.json();
                populateClientDropdown(clients);

                // Fetch Invoices for the list
                const invoiceResponse = await fetch(`${API_BASE}/invoices`);
                const invoices = await invoiceResponse.json();
                renderInvoices(invoices);
                
            } catch (error) {
                console.error('Error fetching data:', error);
                alert('Failed to load clients or invoices.');
            }
        }

        function populateClientDropdown(clients) {
            const select = document.getElementById('clientSelect');
            select.innerHTML = '<option value="">-- Select Client --</option>';
            clients.forEach(client => {
                const option = document.createElement('option');
                option.value = client.id;
                option.textContent = `${client.name} (Phone: ${client.phone || 'N/A'})`;
                select.appendChild(option);
            });
        }

        function renderInvoices(invoices) {
            const list = document.getElementById('invoiceList');
            list.innerHTML = '';
            
            if (invoices.length === 0) {
                list.innerHTML = '<p>No invoices created yet.</p>';
                return;
            }

            invoices.forEach(invoice => {
                const client = clients.find(c => c.id === invoice.client_id) || { name: 'Unknown' };
                const card = document.createElement('div');
                card.className = 'invoice-card';
                
                card.innerHTML = `
                    <div class="invoice-details">
                        <span class="invoice-header">#${invoice.invoice_number}</span>
                        <span>Client: ${client.name}</span>
                        <span>Total: $${invoice.total_amount}</span>
                        <span>Status: <span style="color: ${invoice.status === 'Sent' ? 'green' : 'orange'};">${invoice.status}</span></span>
                    </div>
                    <div class="actions">
                        <button onclick="sendInvoice('${invoice.id}')">Send Bill (WhatsApp)</button>
                        <button onclick="viewInvoiceDetails('${invoice.id}')">View Details</button>
                        <button onclick="deleteInvoice('${invoice.id}')">Delete</button>
                    </div>
                `;
                list.appendChild(card);
            });
        }

        // --- LINE ITEM LOGIC ---

        function calculateSubtotal(row) {
            const quantity = parseFloat(row.querySelector('.item-quantity').value) || 0;
            const price = parseFloat(row.querySelector('.item-price').value) || 0;
            const subtotal = (quantity * price).toFixed(2);
            
            row.querySelector('.item-subtotal').textContent = subtotal;
            
            updateInvoiceTotal();
            // Store subtotal on the element for easy retrieval
            row.dataset.subtotal = subtotal;
        }

        function updateInvoiceTotal() {
            let total = 0.0;
            document.querySelectorAll('#lineItemsBody .line-item-row').forEach(row => {
                const subtotal = parseFloat(row.dataset.subtotal) || 0;
                total += subtotal;
            });
            document.getElementById('invoiceTotal').textContent = total.toFixed(2);
        }

        function addLineItem() {
            const tbody = document.getElementById('lineItemsBody');
            const newRow = tbody.querySelector('.line-item-row').cloneNode(true);
            
            // Clear values and reset subtotal
            newRow.querySelector('.item-description').value = '';
            newRow.querySelector('.item-quantity').value = 1;
            newRow.querySelector('.item-price').value = '0.00';
            newRow.querySelector('.item-subtotal').textContent = '0.00';
            newRow.dataset.subtotal = '0.00';

            tbody.appendChild(newRow);
            updateInvoiceTotal();
        }

        function removeLineItem(row) {
            // Prevent removing the last row
            if (document.querySelectorAll('#lineItemsBody .line-item-row').length > 1) {
                row.remove();
                updateInvoiceTotal();
            } else {
                alert("An invoice must have at least one line item.");
            }
        }

        // --- SUBMISSION LOGIC ---

        async function submitNewInvoice() {
            const client_id = document.getElementById('clientSelect').value;
            const invoice_number = document.getElementById('invoiceNumber').value;
            const issue_date = document.getElementById('issueDate').value;
            const due_date = document.getElementById('dueDate').value;

            if (!client_id || !invoice_number || !issue_date) {
                alert("Please fill in all required header fields (Client, Invoice #, Issue Date).");
                return;
            }

            const line_items = [];
            let isValid = true;
            document.querySelectorAll('#lineItemsBody .line-item-row').forEach(row => {
                const desc = row.querySelector('.item-description').value;
                const qty = parseInt(row.querySelector('.item-quantity').value);
                const price = parseFloat(row.querySelector('.item-price').value);
                const subtotal = parseFloat(row.dataset.subtotal);

                if (!desc || isNaN(qty) || isNaN(price) || isNaN(subtotal) || subtotal === 0) {
                    isValid = false;
                    return;
                }
                
                line_items.push({
                    description: desc,
                    quantity: qty,
                    unit_price: price.toFixed(2),
                    subtotal: subtotal.toFixed(2)
                });
            });

            if (!isValid || line_items.length === 0) {
                alert("Please ensure all line items are filled out correctly and have a non-zero subtotal.");
                return;
            }

            const invoiceData = {
                client_id: parseInt(client_id),
                invoice_number: invoice_number,
                issue_date: issue_date,
                due_date: due_date,
                line_items: line_items
                // total_amount and status are calculated/set on the server
            };

            try {
                const response = await fetch(`${API_BASE}/invoices`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(invoiceData)
                });

                const result = await response.json();
                if (response.ok) {
                    alert('Invoice created successfully! Refreshing list...');
                    document.getElementById('invoiceModal').style.display = 'none';
                    fetchInvoicesAndClients(); // Refresh list
                    resetModalForm();
                } else {
                    alert(`Failed to create invoice: ${result.message}`);
                }
            } catch (error) {
                console.error('Error submitting invoice:', error);
                alert('Network error while submitting invoice.');
            }
        }

        async function sendInvoice(invoiceId) {
            // Note: This relies on your server having a public URL (e.g., ngrok)
            if (!confirm("Are you sure you want to send this invoice PDF via WhatsApp?")) return;

            try {
                const response = await fetch(`${API_BASE}/send_invoice/${invoiceId}`, { method: 'POST' });
                const result = await response.json();

                if (response.ok) {
                    alert(`Success: ${result.message}`);
                    fetchInvoicesAndClients(); // Update status to 'Sent'
                } else {
                    alert(`Failed to send invoice: ${result.message}`);
                }
            } catch (error) {
                console.error('Error sending invoice:', error);
                alert('Network error while attempting to send invoice.');
            }
        }
        
        async function deleteInvoice(invoiceId) {
            if (!confirm("Are you sure you want to delete this invoice? This action cannot be undone.")) return;

            try {
                const response = await fetch(`${API_BASE}/invoices/${invoiceId}`, { method: 'DELETE' });
                const result = await response.json();

                if (response.ok) {
                    alert(result.message);
                    fetchInvoicesAndClients(); // Refresh list
                } else {
                    alert(`Failed to delete invoice: ${result.message}`);
                }
            } catch (error) {
                console.error('Error deleting invoice:', error);
                alert('Network error while deleting invoice.');
            }
        }

        function viewInvoiceDetails(invoiceId) {
            alert("Viewing details for invoice " + invoiceId + " - Implement a dedicated details view here.");
            // Ideally, fetch the single invoice: fetch(`/api/invoices/${invoiceId}`) and display a detailed modal.
        }

        // --- MODAL SETUP ---

        function setupModalListeners() {
            const modal = document.getElementById('invoiceModal');
            document.getElementById('openModalBtn').onclick = () => {
                resetModalForm();
                modal.style.display = 'block';
            };
            document.getElementById('closeModalBtn').onclick = () => {
                modal.style.display = 'none';
            };
            window.onclick = (event) => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            };
        }

        function resetModalForm() {
            // Reset main fields
            document.getElementById('clientSelect').value = '';
            document.getElementById('invoiceNumber').value = '';
            document.getElementById('issueDate').value = new Date().toISOString().substring(0, 10);
            document.getElementById('dueDate').value = '';
            
            // Clear line items except the first one
            const tbody = document.getElementById('lineItemsBody');
            const firstRow = tbody.querySelector('.line-item-row');
            
            tbody.innerHTML = '';
            tbody.appendChild(firstRow); // Re-add the first row
            
            // Reset the first row's values
            firstRow.querySelector('.item-description').value = '';
            firstRow.querySelector('.item-quantity').value = 1;
            firstRow.querySelector('.item-price').value = '0.00';
            firstRow.querySelector('.item-subtotal').textContent = '0.00';
            firstRow.dataset.subtotal = '0.00';

            updateInvoiceTotal();
        }

        // Initialize issue date to today's date
        document.getElementById('issueDate').value = new Date().toISOString().substring(0, 10);

    </script>
</body>
</html>